{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Live Webcam QR Scanner</title>
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
</head>
<body>

<div class="card" style="max-width:700px;margin:50px auto;">
    <h2>Live Webcam QR Scanner</h2>
    <p class="subtitle">Hold your QR code in front of the camera to scan automatically.</p>

    <!-- Html5Qrcode requires a DIV -->
    <div id="qr-reader" style="width:100%; border-radius:0.8rem; margin-bottom:12px;"></div>

    <!-- Loader -->
    <div id="loading" style="display:none; text-align:center;">
        <img src="{% static 'img/loader.gif' %}" width="80">
        <p style="color:#9ca3af;">Analyzing QRâ€¦ Please wait</p>
    </div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
let isScanning = true;
const loader = document.getElementById("loading");

const html5QrCode = new Html5Qrcode("qr-reader");

function sendQrToServer(qrText) {
    loader.style.display = "block";

    fetch("{% url 'webcam_scan' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: "qr_data=" + encodeURIComponent(qrText)
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "success") {
            window.location.href = data.redirect_url;
        } else {
            alert(data.message || "QR processing failed");
            loader.style.display = "none";
            isScanning = true;
        }
    })
    .catch(err => {
        console.error(err);
        alert("Server error while scanning");
        loader.style.display = "none";
        isScanning = true;
    });
}

Html5Qrcode.getCameras().then(cameras => {
    if (!cameras || cameras.length === 0) {
        alert("No camera found on this device.");
        return;
    }

    html5QrCode.start(
        cameras[0].id,
        { fps: 15, qrbox: 300 },
        (qrMessage) => {
            if (!isScanning) return;
            isScanning = false;

            html5QrCode.stop().then(() => {
                sendQrToServer(qrMessage);
            });
        }
    ).catch(err => {
        console.error("Camera start failed:", err);
        alert("Camera permission denied or unavailable");
    });
});
</script>

</body>
</html>
